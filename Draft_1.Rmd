---
title: "Untitled"
output:
  pdf_document: default
  html_document: default
date: "2022-10-27"
---
```{r,echo=F}
#Initial environment setup
setwd("~/Desktop/GLM/Coursework/GLM-CW")
expend.df <- read.table("expenditure.txt")
library(tidyverse)
library(kableExtra)
library(gridExtra)
library(broom)
library(MASS)
```

```{r,echo=F}
#Data cleaning

#coding variables as factors
expend.df$house.ten <- factor(expend.df$house.ten,levels=c(1:3),labels=c("Public Rented","Private rented","Owned"))
expend.df$sex.hh <- factor(expend.df$sex.hh,levels=c(1,2),labels=c("Male","Female"))
expend.df$lab.force <- factor(expend.df$lab.force,levels=c(1:4),labels=c("Full time", "Part time","Unemployed","Inactive"))
expend.df$hh.size <- factor(expend.df$hh.size,levels=c(1:5),labels = c("1 person","2 people","3 people","4 people","5+ persons"))
expend.df$hh.adults <- factor(expend.df$hh.adults,levels = c(1:4), labels = c("1 adult","2 adults","3 adults","4+ adults"))

```
## Task 1:

#### Part 1:
```{r,echo=F}
#Histogram to examine the expenditure
hist(expend.df$expenditure,breaks = 20,
     xlab = "Total weekly household expenditure (GBP)",
     main = "Histogram of expenditure")

#Creating the 
#scatter plot to look at relationship between income and expenditure
p1<-ggplot(data=expend.df,aes(x=income,y=expenditure))+
  geom_point(size=0.2)+
  xlab("Gross weekly average household income (GBP)")+
  ylab("Total expenditure")+
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=6,face="bold"))

#boxplots
p2<-ggplot(data=expend.df,aes(y=expenditure,x=house.ten,fill=house.ten))+
  geom_boxplot()+
  xlab("Household tenure")+
  guides(fill=F)

#scale_fill_discrete(name="Household\ntenure")

p3<-ggplot(data=expend.df,aes(y=expenditure,x=sex.hh,fill=sex.hh))+
  geom_boxplot()+
  xlab("Sex of the household head")+
  guides(fill=F)
  
p4<-ggplot(data=expend.df,aes(y=expenditure,x=lab.force,fill=lab.force))+
  geom_boxplot()+
  xlab("Employment status")+
  guides(fill=F)

p5<-ggplot(data=expend.df,aes(y=expenditure,x=hh.size,fill=hh.size))+
  geom_boxplot()+
  xlab("Household size")+
  guides(fill=F)

p6<-ggplot(data=expend.df,aes(y=expenditure,x=hh.adults,fill=hh.adults))+
  geom_boxplot()+
  xlab("Number of adults in the household")+
  guides(fill=F)

grid.arrange(p1,p2,p3,p4,p5,p6,ncol=2,nrow=3)
```



Looking at the above histogram of expenditure above it shows that expenditure has a positively skewed distribution.

I investigated the relationships between the other variable and expenditure dataset using the plots above.
We can see that there is a positive association between household income and expenditure in the scatter plot.
For the factor variables I used box plots to examine any differences present between the different levels within the factor variable and expenditure:
Different household tenure categories have different expenditure amounts with public rented households having a noticeably lower expenditure compared to the other 2 household levels
Households with a female head appear to have a lower expenditure than that of male household heads
Employment status appears to be associated with expenditure with unemployed having a dramatically lower expenditure compared to full and part time employment categories.
Household size appears to be positively correlated with expenditure, with larger households having higher expenditure except for 5+ person households which goes against this trend (further investigation?)
Number of adults in the household also appears positively correlated with households containing more adults having a higher expenditure.


#### Part 2:

```{r,echo=F}
#Question 2
lm.income<-lm(expenditure~income,data = expend.df)
#summary(lm.income)
as.data.frame(tidy(lm.income)[,1:3])%>%
  kable(escape = F)%>%
  kable_styling(font_size = 15)
par(mfrow=c(2,2))
plot(lm.income)
```
Fitting a linear model $y_{i}=\beta_{0}+\beta_{1}x_{i}+\epsilon$ with the response $y$ the expenditure,the explanatory variable $x$ income and $i \in \{1,...,1200\}$ the ith household. The above table shows the estimated values of the intercept ($\beta_0$) and the estimated 'effect' of a 1 pound increase in income on expenditure $\beta_1$ and there standard errors.

Viewing the diagnostic plots for this model. The fitted vs residual plot shows the residuals are not equally spread around 0 with a greater spread of residuals above zero, meaning the assumption of linearity may not hold. Furthermore, the QQ normal plot has a u shape with the tails diverging heavily away from the straight line. This implies the normality assumption is invalid.

#### Part 3:
```{r,echo=F}
#Question 3
lm.income.sqd <- lm(expenditure~income+I(income^2),data = expend.df)
tidy(lm.income.sqd)[,1:3]%>%
  kable(escape = F)%>%
  kable_styling(font_size = 15)
par(mfrow=c(2,2))
plot(lm.income.sqd)

# lm.log.income.sqd <- lm(log(expenditure)~income+I(income^2),data = expend.df)
# summary(lm.log.income.sqd)
# plot(lm.log.income.sqd)
# 
# gamma.income.sqd <-glm(expenditure~income+I(income^2),data=expend.df,family="Gamma")
# summary(gamma.income.sqd)
# plot(gamma.income.sqd)
```
Fitting a new linear model $y_{i}=\beta_{0}+\beta_{1}x_{i}+\beta_2x^2_{i}+\epsilon$ gives the above estimated coefficients. Looking at the diagnostic plots, in the fitted vs residual plot the residual values increase as the fitted values increase thus the homoscedasticity assumption may not be valid. The tails in the normal QQ plot also still deviate heavily away from the straight line meaning the normality assumption is invalid.

#### Part 4:
```{r,echo=F}
#Question 4
lm.log.income<-lm(log(expenditure)~income,data = expend.df)
tidy(lm.log.income)[,1:3]%>%
  kable(escape = F)%>%
  kable_styling(font_size = 15)
par(mfrow=c(2,2))
plot(lm.log.income)
# #QQ plot much better but not sure about the residual vs fitted if the variance decreases as fitted value increases
```
Fitting the model $log(y_{i})=\beta_{0}+\beta_{1}x_{i}+\epsilon$. The data appears to be hetroscedastic as the fitted vs residual plot points spread decreases as fitted values increases/ not. The QQ plot shows the residuals stay close to the straight line thus normality assumption is valid. 

#### Part 5:
```{r,echo=F}
lm.log.income.sqd <- lm(log(expenditure)~income+I(income^2),data = expend.df)
tidy(lm.log.income.sqd)[,1:3]%>%
  kable(escape = F)%>%
  kable_styling(font_size = 15)
par(mfrow=c(2,2))
plot(lm.log.income.sqd)
```
Fitting the model $log(y_{i})=\beta_{0}+\beta_{1}x_{i}+\beta_{2}x^2_{i}+\epsilon$ gives the estimated coefficients above. Viewing the diagnostic plots the fitted vs residuals plot shows a fairly even scattering of points around 0 thus the linearity assumption appears valid. The QQ plot shows the points stay close to the straight line meaning the normality assumption is valid.
(scale location is slightly dogy- sign constant variance assumption has been violated)

#### Task 6
```{r}
#Comparing AIC
AIC(lm.income)
AIC(lm.income.sqd)
AIC(lm.log.income)
AIC(lm.log.income.sqd)
#Comparing R squared
glance(lm.income)$r.squared
glance(lm.income.sqd)$r.squared
glance(lm.log.income)$r.squared
glance(lm.log.income.sqd)$r.squared
#Comparing adjusted R squared
glance(lm.income)$adj.r.squared
glance(lm.income.sqd)$adj.r.squared
glance(lm.log.income)$adj.r.squared
glance(lm.log.income.sqd)$adj.r.squared
```

Using AIC as a measure of fit the best is model 4 as it has the lowest AIC value. Furthermore, model 4 has the highest $R^2$ and adjusted $R^2$ suggestion that model 4 'fits' the data best. This is further backed up by the diagnostic plots which indicate that this is the only model in which the linearity and normality assumptions are met. Due to all these reasons model 4 as my preferred model.


```{r}
tidy(lm.log.income.sqd)

mean(expend.df$income)
```
Using the model a 1 unit increase in household income increase the expenditure by $exp(\beta_1+2x\beta_2+\beta_2)-1$x100% of the old value. Subbing in the values of $\beta_1$ and $\beta_2$ this gives an increase by $exp(0.0032-0.0000029x-0.0000015)-1$x100%. Therefore for a household earning the mean income of £512 a £1 increase in income increases expenditure by approximately 0.17%. Using a more likely realistic increase in weekly income of £20 for a household earning £512 gives an increase of $exp(0.016-0.000015*20-0.000036)-1$x100% = 1.6%.

Include CI?

#### Task 7

I started by only considering 2 way interactions that could be plausible for example income may have a different effect on expenditure depending on sex of household head. Furthermore the number of adults or household tenure type may impact the effect of income on expenditure as.... above I investigated if there were differences when sub categorising the categories to see if there where plausible interactions between factor variables, however none showed any significant differences between the different cohorts (initial factors)

#### Model selection
For this model selection process I decided to only consider 2 way interactions as higher order interactions make interpretation of the model much more complicated.
When considering which interactions to include I first created plots to examine if there are any clear interactions between income and the other covariates. Considering the factor covarites thinking about the possible interactions none made much logical sense e.g. a household female head would have a different effect on expenditure to a male head depending on the number of people in the household. Thus didn't include any factor:factor interactions in the model.

```{r}
#interaction between sex and income
interaction.continous <-function(var){
  ggplot(data=expend.df,aes(x=income,y=expenditure,colour=.data[[var]]))+
    geom_point(size=0.1)
}


int1<-interaction.continous("house.ten")
int2<-interaction.continous("sex.hh")
int3<-interaction.continous("lab.force")
int4<-interaction.continous("hh.size")
int5<-interaction.continous("hh.adults")

grid.arrange(int1,int2,int3,int4,int5,ncol=2,nrow=3)
int1
int2
int3
int4
int5
```
Looking at the scatter plots each factor for the plots does appear to have a different gradient thus an interaction could be present. Therefore for the model selection process I will start with a full model with all covariates and the pairwise interactions between income and each of the factor variables. Then using AIC I remove the coefficient that gives the biggest increase in AIC until no increase in AIC can be attained. Using this step method I will come to my first potential final model. 

```{r}
lm.log.full<-lm(log(expenditure)~income+I(income^2)+income*sex.hh+income*hh.adults+income*house.ten+lab.force*income+hh.size*income,data=expend.df)
step.method<- step(lm.log.full,trace=F)
tidy(step.method)
AIC(step.method)
glance(step.method)$adj.r.squared
plot(step.method)
#got rid of 2 interactions: income:sex and income:hhsize
```


```{r}
lm.log.full.no.int<-lm(log(expenditure)~income+I(income^2)+sex.hh+hh.adults+house.ten+lab.force+hh.size,data=expend.df)
summary(lm.log.full.no.int)
step.method<- step(lm.log.full.no.int,trace=F)

plot(lm.log.full.no.int)
```

Using AIC as the selection critera the best model without interactions is the full model.

Now I try adding interactions that couold make logical sense.

As a sex of the household head could impact the effect of income on expenditure (perhaps males are more likely to spend then save then females as they get more money or the reverse)

The number of adults my affect the affect of income as more adults from a higher income household may be more likely to spend more 

The type of household tenure may affect the

```{r}
#adding these into the model 1 by 1
new.lm.add.sex<-update(lm.log.full.no.int, .~.+income*sex.hh)
anova(lm.log.full.no.int,new.lm.add.sex)
summary(new.lm.add.sex)

AIC(lm.log.full.no.int)
AIC(new.lm.add.sex)

glance(lm.log.full.no.int)$adj.r.squared
glance(new.lm.add.sex)$adj.r.squared
#Not really much difference and note that interaction is not significant

new.lm.add.adults<-update(lm.log.full.no.int, .~.+income*hh.adults)
anova(lm.log.full.no.int,new.lm.add.adults)
summary(new.lm.add.adults)

AIC(lm.log.full.no.int)
AIC(new.lm.add.adults)

glance(lm.log.full.no.int)$adj.r.squared
glance(new.lm.add.adults)$adj.r.squared


new.lm.add.ten<-update(lm.log.full.no.int, .~.+income*house.ten)
anova(lm.log.full.no.int,new.lm.add.ten)
summary(new.lm.add.ten)

AIC(lm.log.full.no.int)
AIC(new.lm.add.ten)

glance(lm.log.full.no.int)$adj.r.squared
glance(new.lm.add.ten)$adj.r.squared


AIC(lm.log.full)
AIC(lm.log.full.no.int)
glance(lm.log.full.no.int)$adj.r.squared
glance(lm.log.full)$adj.r.squared
```

```{r}
# Attempting Box-Cox transformation to check whether distribution is better
estim_BoxCox <- boxcox(expenditure ~ income+sex.hh+hh.adults+house.ten+lab.force+hh.size+income:hh.adults+income:house.ten+income:lab.force,data =expend.df)
# Find optimal lambda
lambda <- estim_BoxCox$x[ which.max( estim_BoxCox$y ) ]
```


